<head>
  <!-- Vendor -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script> -->
  <script src="/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="/mustache.js" type="text/javascript" charset="utf-8"></script>

  <!-- Searchlite -->
  <script src="/src/search.js" type="text/javascript" charset="utf-8"></script>
  <script src="/src/utils.js" type="text/javascript" charset="utf-8"></script>
  <script src="/src/deferred.js" type="text/javascript" charset="utf-8"></script>
  <script src="/src/store.js" type="text/javascript" charset="utf-8"></script>
  <script src="/src/index.js" type="text/javascript" charset="utf-8"></script>
  <script src="/src/document.js" type="text/javascript" charset="utf-8"></script>
  <script src="/src/word.js" type="text/javascript" charset="utf-8"></script>

  <script id="question-list-template" type="text/mustache">
    <div>
      <ul>
        {{#questions}}
          <li data-question-id="{{id}}">
            <h2><a href="#">{{title}}</a></h2>
            <p>{{tags}}</p>
          </li>
        {{/questions}}
      </ul>
    </div>
  </script>

  <script id="question-view-template" type="text/mustache">
    <div>
      <h1>{{title}}</h1>
      <p>{{tags}}</p>
      <div>{{{body}}}</div>
    </div>
  </script>

  <script type="text/javascript" charset="utf-8">

    // set up the index, specifying that we want to index the title, tags and body fields of documents.
    var idx = Searchlite("barbar", function () {
      this.field('title', {
        'multiplier': 10
      })

      this.field('tags', {
        'multiplier': 100
      })

      this.field('body')
    })

    $(document).ready(function () {

      // load view templates
      var questionViewTemplate = $("#question-view-template").text()
      var questionListTemplate = $("#question-list-template").text()

      var renderQuestionList = function (qs) {
        $("#question-list-container")
          .empty()
          .append(Mustache.to_html(questionListTemplate, {questions: qs}))
      }

      var renderQuestionView = function (question) {
        $("#question-view-container")
          .empty()
          .append(Mustache.to_html(questionViewTemplate, question))
      }


      // load the example data
      $.getJSON('/example_data.json', function (data) {

        // format the raw json into a form that is simpler to work with
        var questions = data.questions.map(function (raw) {
          return {
            id: raw.question_id,
            title: raw.title,
            body: raw.body,
            tags: raw.tags.join(' ')
          }
        })

        if (!localStorage.getItem('indexLoaded?')) {
          idx.storageInitialized.then(function () {
            idx.addList(questions).then(function () {
              localStorage.setItem('indexLoaded?', true)
              $('.loading').fadeOut()
            })
          })
        } else {
          $('.loading').hide()
        };

        // this is the main app
        renderQuestionList(questions)
        renderQuestionView(questions[0])

        $('a.all').bind('click', function () {
          renderQuestionList(questions)
          $('input').val('')
        })

        $('input').bind('change', function () {
          var query = $(this).val()
          idx.search(query).then(function (results) {
            renderQuestionList(results)
          })
        })

        // clicking a list item displays it in the main view
        $("#question-list-container").delegate('li', 'click', function () {
          var li = $(this)
          var id = li.data('question-id')

          renderQuestionView(questions.filter(function (question) {
            return (question.id == id)
          })[0])
        })
      })
    })

  </script>

  <style type="text/css" media="screen">

    body {
      font-family: helvetica;
      color: #333;
    }

    input {
      width: 200px;
      font-size: 1.4em;
    }

    #wrap {
      width: 960px;
      margin-left: auto;
      margin-right: auto;
    }

    #question-list-container {
      float: left;
      width: 30%;
    }

    #question-view-container {
      float: right;
      width: 65%;
    }

    .loading {
      color: red;
      font-size: 0.9em;
      border: 1px solid red;
      padding: 10px;
    }

    .controls {
      padding-top: 30px;
      padding-bottom: 10px;
      border-top: 3px dashed #333;
    }
  </style>

</head>
<body>
  <div id="wrap">
    <header>
      <h1>Searchlite.js Example</h1>
    </header>

    <article>
      <p>This demo consists of 100 questions taken from stack overflow, they are listed on the left hand side.  Clicking on the headings will display the full question on the right hand side of the page.</p>

      <p>Each question contains a heading, a list of tags and the body of the question.  All three fields are in the index and you can search using any words you want.</p>

      <p class="loading">The index is currently being loaded, you can still search but currently not all the data has been indexed.</p>
    </article>

    <div class="controls">
      <input type="search" placeholder="Search..."></input>
      <a class="all" href="#">All</a>
    </div>

    <div class="questions">
      <div id='question-list-container'></div>
      <div id='question-view-container'></div>
    </div>
  </div>
</body>